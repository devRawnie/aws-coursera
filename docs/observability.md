# Observability

### Monitoring

Act of collecting data

- Collect Metrics
- Collect Logs
- Monitor Network Traffic

### Observability

- Property of a system
- An observable system, lets us observe it via logs and metrics

## AWS X-RAY

- Allows us to debug de-centralized applications
- Provide end-to-end view of the request as it travells

- **SEGMENTS**: Compute resources running the application logic
- **SUB-SEGMENTS**: Provide granular details about segments
- **SERVICE-GRAPH**: JSON Document containing details about services in our application -> Used to visualize the request
- **TRACE**: Tracking the path of a request through the system, collecting all the segments generated by the request

Sampling Algorithm

- Determines which algorithm will get traced
- Default sampling rate: 1st request per second + 5% of additional request


## Integration

1. API Gateway

Two types of tracing
- Passive : Default. Requests would be traced if X-ray is active on an upstream service. I.E. if Tracing is enabled on API Gateway, it will add a tracing header to the request, which will tell other services to also trace the request
- Active : Enable tracing manually so that traces are recorded for sub-segments, not traced in Passive tracing, based on the Sampling Algorithm

API Gateway -> Stage -> Logs/Tracing section

SDK ---- Trace Data ---> X-Ray Daemon -> X-Ray API

**Trace Data**
- HTTP Requests
- Downstream Calls
- HTTP Clients
- SQL Database connectors

Annotations and Metadata can be added at the sub-segment level by the SDK

- **Annotations**: Key-Value pairs, associated with a trace ande used for searching the trace later
- **Metadata**: cannot be searched upon, but can be used to store further information. It can be Key-Value, Object, List

- If code is running on AWS Lambda, the X-ray Daemon is installed and managed automatically
- If code is running X-ray outside of Lambda you may need to install and manage the daemon yourself
- To send logs from Lambda to Cloudwatch, write to `stdout` and `stderr`

- Logs from different origins, in our serverless application need to be collected

## Amazon Cloudwatch Logs

- **Log Event**: Contains time-stamp of occuring and the raw data of the event. Ex: Invocation of one instance of lambda function
- **Log Stream**: Sequence of logs that share the same source. Ex: Invocation of multiple instances of one lambda function
- **Log Group**: Group of logs, that share the same retention and access-control policy. Ex: Lambda Function
- **Retention Settings**: Defined settings for how long a log-event would be stored before removing it

### Cloudwatch Integration
1. **API Gateway**: Create an IAM Role with access to Cloudwatch logs
  1. Execution Logging: For event occurring in the Gateway with the saved in-out flow. **Context** variable is passed here
  2. Access Logging: Only available for REST API. Logs the entire request
2. **AWS Step Functions**: Enabled by default for Expres workflow. For standard, need to be enabled manually 


